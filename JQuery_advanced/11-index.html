<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>Task 8</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  </head>

  <body>
    <script type="application/javascript">
      function addPostRow(data) {
        const paragraph = $("<p>").attr("id", `row-${data.id}`);
        const deleteSpan = $("<span>")
          .text("(delete) ")
          .css("cursor", "pointer")
          .on("click", function () {
            deletePost(data.id);
          });
        const span = $("<span>").text(
          `Post created with id ${data.id}, title: ${data.title}, author: ${data.author}`
        );
        paragraph.append(deleteSpan, span);
        $("body").append(paragraph);
      }

      function deletePost(id) {
        $.ajax({
          url: `http://localhost:3000/posts/${id}`,
          method: "DELETE",
        })
          .done(function () {
            $(`#row-${id}`).remove();
          })
          .fail(function () {
            alert("Post was not deleted");
          });
      }

      function listPosts() {
        $.get("http://localhost:3000/posts")
          .done(function (response) {
            response.forEach(function (post) {
              addPostRow(post);
            });
          })
          .fail(function () {
            alert("Server Error");
          });
      }

      function buildForm() {
        const form = $("<form>");
        const divAuthor = $("<div>");
        const labelAuthor = $("<label>").attr("for", "author").text("Author");
        const inputAuthor = $("<input>").attr({ type: "text", id: "author" });
        divAuthor.append(labelAuthor, inputAuthor);
        const divTitle = $("<div>");
        const labelTitle = $("<label>").attr("for", "title").text("Title");
        const textareaTitle = $("<textarea>").attr("id", "title");
        divTitle.append(labelTitle, textareaTitle);
        const submit = $("<input>").attr("type", "submit");
        form.on("submit", function (event) {
          event.preventDefault();
          sendForm();
        });
        form.append(divAuthor, divTitle, submit);
        $("body").append(form);
      }

      function sendForm() {
        $("form").after("<p>About to send the query to the API</p>");
        const data = {
          title: $("#title").val(),
          author: $("#author").val(),
        };
        $.ajax({
          url: "http://localhost:3000/posts",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
        })
          .done(function (response) {
            addPostRow(response);
          })
          .fail(function () {
            alert("Error sending the POST query");
          });
      }

      $(document).ready(function () {
        listPosts();
        buildForm();
      });
    </script>
  </body>
</html>
